;(function(root,factory){if(typeof define==='function'&&(define.amd||define.cmd)){define(function(require,exports,module){module.exports=factory(root,{});});}else{root.monitor=factory(root,{});}})(window,function(root,param){var speedPoints={};var clickStart=0;var webviewStart=0;var loadUrl=0;var pageFinish=0;var netWorkInfo='';var platform='android';var visible=true;var isOffline=0;var isPreloadWebProcess=false;var isWebViewCache=false;var redirect302Time=null;var _storage={set:function(key,data,expires){try{if(window.localStorage){var exp='['+(+new Date)+':'+(expires*1000||0)+']',data=typeof data=='object'?(window.JSON?JSON.stringify(data):''):data;localStorage.setItem(key,exp+data);}}catch(e){}},get:function(key,toJson){if(window.localStorage){var data=localStorage.getItem(key);if(!data)return null;if(!(data=data.match(/^\[(\d+):(\d+)\]([\s\S\r\n]*)/)))return null;if(data&&(Date.now())-data[1]>data[2])return null;return toJson?JSON.parse(data[3]):data[3];}
return null;}};var _make_rnd=function(){return(+new Date())+'.r'+Math.floor(Math.random()*1000);};var _checkDuplicate=function(key,ts){var ls_ts=_storage.get(key,false);if(ls_ts==ts){return true;}
_storage.set(key,ts,7200);return false;};var monitor=monitor||{};monitor.report=function(param){if(!param||!param.appId||!param.buzId||!param.siteId||!param.pageId){console.log("param error ");return;}
var delay=param.delay===undefined?3:param.delay;if(!param.gray||param.gray<1){param.gray=1;}else{param.gray=Math.floor(param.gray);}
var REGEXP_IOS_QQ=/(iPad|iPhone|iPod).*? (IPad)?QQ\/([\d\.]+)/;if(REGEXP_IOS_QQ.test(window.navigator.userAgent)){platform='ios';}else{platform='android';}
var performanceList=(function(){if(typeof window.performance!='undefined'){try{var navigationTime=window.performance.timing;var field=["navigationStart","unloadEventStart","unloadEventEnd","redirectStart","redirectEnd","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","domLoading","domInteractive","domContentLoadedEventStart","domContentLoadedEventEnd","domComplete","loadEventStart","loadEventEnd"];var startTime=navigationTime.navigationStart;var timeList={};for(var i=1,j=field.length;i<j;i++){if(typeof navigationTime[field[i]]!='undefined'&&navigationTime[field[i]]>0){var timeMs=navigationTime[field[i]]-startTime;if(timeMs>0&&timeMs<100000){timeList[i]=timeMs;continue;}}
timeList[i]=0;}
return timeList;}catch(e){return null;}}else{return null;}})();if(performanceList==null){for(var i=1;i<=19;i++){speedPoints[i]=0;}}
else{speedPoints=performanceList;}
var done_counter=0;var done_call=function(){done_counter++;if(done_counter>=2){var ran=Math.floor(Math.random()*1000000);if(0==ran%(param.gray||1)){setTimeout(function(){_doVACReport(param);},delay*1000);}}}
if(mqq&&mqq.support&&mqq.support('mqq.data.getPerformance')){setTimeout(function(){mqq.data.getPerformance(function(json){if(json&&0==json.result&&json.data){clickStart=json.data.clickStart||0;webviewStart=json.data.webviewStart||0;loadUrl=json.data.pageStart||0;pageFinish=json.data.pageFinish||0;isOffline=json.data.isUseLocalSrc||0;isPreloadWebProcess=json.data.isPreloadWebProcess||0;isWebViewCache=json.data.isWebViewCache||false;redirect302Time=json.data.redirect302Time||0;}
done_call();});},0);}else{done_call();}
var netMap={0:"unknown",1:"wifi",2:"2g",3:"3g",4:"4g"};if(mqq&&mqq.support&&mqq.support('mqq.device.getNetworkType')){mqq.device.getNetworkType(function(data){if(data){netWorkInfo=netMap[data]||"unknown";}
done_call();});}else{done_call();}};var _doVACReport=function(param){var ls_key_prefix=['vac_qw_monitor',param.buzId,param.siteId,param.pageId].join('_');if(clickStart&&_checkDuplicate(ls_key_prefix,clickStart)){return false;}
param=param||{};var compassPoints=param.compassPoints||{};var head=param.commPoints.head instanceof Date?param.commPoints.head.getTime():param.commPoints.head;var domready=param.commPoints.domready instanceof Date?param.commPoints.domready.getTime():param.commPoints.domready;var active=param.commPoints.active instanceof Date?param.commPoints.active.getTime():param.commPoints.active;if(clickStart&&head&&domready&&active&&visible){speedPoints[20]=webviewStart-clickStart;speedPoints[21]=loadUrl-clickStart;speedPoints[22]=head-clickStart;speedPoints[23]=domready-clickStart;speedPoints[24]=active-clickStart;for(var i in param.expoints){if(isNaN(i)||i*1<28){continue;}
speedPoints[i]=param.expoints[i];}
var timep=[];timep.push("1="+clickStart);timep.push("2="+webviewStart);timep.push("3="+loadUrl);timep.push("4="+head);timep.push("5="+domready);timep.push("6="+active);var needReport=false;var arr=[];for(var i in speedPoints){if(speedPoints[i]>=0){arr.push(i+"="+speedPoints[i]);if(!needReport&&speedPoints[i]>0){needReport=true;}}}
if(needReport){var url=location.protocol+'//proxy.vac.qq.com/cgi-bin/report.fcgi?';url+='appid='+param.appId+'&platform='+platform+'&apn='+netWorkInfo+'&speedparams='+encodeURIComponent('flag1='+param.buzId+'&flag2='+param.siteId+'&flag3='+param.pageId+'&'+arr.join('&'));if(timep.length>0){url+='&vacTimepoint='+encodeURIComponent(timep.join('&'));}
var bizType=(typeof param.biz==='undefined')?'1':param.biz;url+='&vacInner='+encodeURIComponent('offline='+(isOffline?1:0)+'&preweb='+(isPreloadWebProcess?1:0)+'&cached='+'&biz='+bizType);var n='jsFeImage_'+_make_rnd(),img=window[n]=new Image();img.onload=img.onerror=function(){window[n]=null;};img.src=url;}}};document.addEventListener("qbrowserVisibilityChange",function(e){visible=false;});return monitor;});